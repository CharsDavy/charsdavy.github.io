<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>睡前谈谈 CAAnimation 动画相关 - Chars&#39;s Tech Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="要让一个 CALayer 动起來，除了通过改变 layer 的 animanatable 的属性外，就是建立 CAAnimation 实例，然后 layer 调用 -addAnimation:forKey:。我们通常会选择一种 CALayer 的 subclass，制作我们想要的动画效果。
这里我们来好好看看 CAAnimation 相关知识，以期使用它来完成我们想要的动画效果。">
<meta property="og:type" content="article">
<meta property="og:title" content="睡前谈谈 CAAnimation 动画相关">
<meta property="og:url" content="http://charsdavy.github.io/2016/07/29/animation-caanimation/index.html">
<meta property="og:site_name" content="Chars's Tech Blog">
<meta property="og:description" content="要让一个 CALayer 动起來，除了通过改变 layer 的 animanatable 的属性外，就是建立 CAAnimation 实例，然后 layer 调用 -addAnimation:forKey:。我们通常会选择一种 CALayer 的 subclass，制作我们想要的动画效果。
这里我们来好好看看 CAAnimation 相关知识，以期使用它来完成我们想要的动画效果。">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-1.png?imageView/2/w/500">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-2.png?imageView/2/w/500">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-3.png?imageView/2/w/500">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-4.png?imageView/2/w/500">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-5.png?imageView/2/w/500">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-6.png?imageView/2/w/500">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-7.png?imageView/2/w/500">
<meta property="og:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-8.png?imageView/2/w/800">
<meta property="og:updated_time" content="2016-08-02T05:56:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="睡前谈谈 CAAnimation 动画相关">
<meta name="twitter:description" content="要让一个 CALayer 动起來，除了通过改变 layer 的 animanatable 的属性外，就是建立 CAAnimation 实例，然后 layer 调用 -addAnimation:forKey:。我们通常会选择一种 CALayer 的 subclass，制作我们想要的动画效果。
这里我们来好好看看 CAAnimation 相关知识，以期使用它来完成我们想要的动画效果。">
<meta name="twitter:image" content="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-1.png?imageView/2/w/500">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80507808-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo logo-text" href="/">Chars</a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/atom.xml">Rss</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://charsdavy.github.io"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-animation-caanimation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      睡前谈谈 CAAnimation 动画相关
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/07/29/animation-caanimation/" class="article-date">
  <time datetime="2016-07-29T11:55:33.000Z" itemprop="datePublished">2016-07-29</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

      
        <div class="article-comment-link-wrap">
          <a href="http://charsdavy.github.io/2016/07/29/animation-caanimation/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>要让一个 CALayer 动起來，除了通过改变 layer 的 animanatable 的属性外，就是建立 CAAnimation 实例，然后 layer 调用 -addAnimation:forKey:。我们通常会选择一种 CALayer 的 subclass，制作我们想要的动画效果。</p>
<p>这里我们来好好看看 CAAnimation 相关知识，以期使用它来完成我们想要的动画效果。</p>
<a id="more"></a>
<h1 id="CATransition"><a href="#CATransition" class="headerlink" title="CATransition"></a>CATransition</h1><p>我们先从 Core Animation 內的转场效果 CATransition 讲起（请不要跟 CATransaction 搞混），因为 CATransition 大概是最容易上手，而且可以马上有成就感的动画。CATransition 通常用在两个 view 之间的切换；UIView 本身就有定义一些跟转场有几个以 transition 开头的 class method，像是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ transitionWithView:duration:options:animations:completion:</span><br><span class="line">+ transitionFromView:toView:duration:options:completion:</span><br></pre></td></tr></table></figure>
<p>而这些 method 可以设定的 tansition option 包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UIViewAnimationOptionTransitionNone</span><br><span class="line">UIViewAnimationOptionTransitionFlipFromLeft</span><br><span class="line">UIViewAnimationOptionTransitionFlipFromRight</span><br><span class="line">UIViewAnimationOptionTransitionCurlUp</span><br><span class="line">UIViewAnimationOptionTransitionCurlDown</span><br><span class="line">UIViewAnimationOptionTransitionCrossDissolve</span><br><span class="line">UIViewAnimationOptionTransitionFlipFromTop</span><br><span class="line">UIViewAnimationOptionTransitionFlipFromBottom</span><br></pre></td></tr></table></figure>
<p>也就是说，UIView 本身就已经提供了四种方向的翻转（上下左右）、淡入淡出与翻页几种转场效果。其实这些效果都是用 Core Animation 实现的，而 CATransition 所提供的效果也远比这些多，只要我们知道怎样使用 CATransition，就可以使用更多的转场效果。</p>
<p>我们来写一个简单的 view controller：这个 view controller 的 view 上面我们额外建立一个 CALayer，然后加了一个按钮，这个按钮按下去之后的 action 是让这个 layer 在红色与绿色之间切换。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//ViewController.h</span><br><span class="line"></span><br><span class="line">@import UIKit;</span><br><span class="line">@import QuartzCore;</span><br><span class="line"></span><br><span class="line">@interface ViewController : UIViewController</span><br><span class="line">- (IBAction)toggleColor:(id)sender;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//ViewController.m</span><br><span class="line"></span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface ViewController ()</span><br><span class="line">@property (strong, nonatomic) CALayer *aLayer;</span><br><span class="line">@property (assign, nonatomic) BOOL isGreen;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    self.aLayer = [[CALayer alloc] init];</span><br><span class="line">    self.aLayer.frame = CGRectMake(50, 50, 100, 100);</span><br><span class="line">    self.aLayer.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">    [self.view.layer addSublayer:self.aLayer];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (IBAction)toggleColor:(id)sender</span><br><span class="line">&#123;</span><br><span class="line">    self.isGreen = !self.isGreen;</span><br><span class="line">    self.aLayer.backgroundColor = self.isGreen ? [UIColor greenColor].CGColor : [UIColor redColor].CGColor;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>原本这个版本只会产生 0.25 秒的属性变化，使用的是淡入淡出效果。我们来加入 kCATransitionMoveIn 这个转场效果看看，就会变成新的画面从上方推入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)toggleColor:(id)sender</span><br><span class="line">&#123;</span><br><span class="line">    self.isGreen = !self.isGreen;</span><br><span class="line">    self.aLayer.backgroundColor = self.isGreen ? [UIColor greenColor].CGColor : [UIColor redColor].CGColor;</span><br><span class="line">    CATransition *transition = [[CATransition alloc] init];</span><br><span class="line">    transition.type = kCATransitionMoveIn;</span><br><span class="line">    transition.subtype = kCATransitionFromRight;</span><br><span class="line">    [self.aLayer addAnimation:transition forKey:@&quot;tansition&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CATransition 可以应用的地方不只是切换背景颜色而已，无论是改变这个 layer 的任何 animatable 的属性，像是改变 contents，或是在这个 layer 中增加或移除 sublayer，用 addAnimation:forKey: 加入了 CATransition 实例之后，都可以产生转场效果。</p>
<p>如果我们想要像 UIView 的 <code>+transitionWithView:duration:options:animations:completion:</code>那样，是在某个 view 上面增加或移除 subview 的时候产生转场效果，用 CATransition 的作法也差不多，我们先写好要某个 view A 新增或移除 subview，然后把 CATransition 加到 view A 的 layer 上即可。</p>
<p>苹果在 iOS 上的 CATransition 的 public header 中定义了几个 type：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kCATransitionFade：淡入淡出动画</span><br><span class="line">kCATransitionMoveIn：新的画面从上方移入的效果</span><br><span class="line">kCATransitionPush：推挤效果，很像 navigation controller 的换页</span><br><span class="line">kCATransitionReveal：原本的画面从上方移出的效果</span><br></pre></td></tr></table></figure>
<p>不过…其实苹果有不少 private API 可以用。比方说，我们可以把 type 指定成立体块状翻转效果。</p>
<p><code>transition.type = @&quot;cube&quot;;</code></p>
<p>在 <a href="http://iphonedevwiki.net/index.php/CATransition">http://iphonedevwiki.net/index.php/CATransition</a> 这一页上可以看到整理好的 private API 可以调用。虽然苹果的政策是禁止在上架的 app 中调用 private API，如果用了可能会被 reject…不过印象中其实有很多 app 都用到这些 private API。</p>
<p>如果对內部的这些效果，甚至 private 的效果都不满意的話，iOS 5 之后， CATransition 还有一个叫做 filter 的属性，我们可以在这个属性上加上 CIFilter 实例，定义更多的转场效果。</p>
<p>另外要注意，在我們调用 <code>addAnimation:forKey:</code> 的时候，如果加入的是个 CATransition 动画，无论使用了怎样的名称当做 key，key 都会是 transition。</p>
<h1 id="CAPropertyAnimation"><a href="#CAPropertyAnimation" class="headerlink" title="CAPropertyAnimation"></a>CAPropertyAnimation</h1><p>CAPropertyAnimation 便是通过设定某个 CALayer 的属性产生动画。前面提到，只要修改 layer 的 animatable 属性会自动产生动画效果，不过，跟使用 CAPropertyAnimation 的状况不太一样，我们对某个 layer 加入了 CAPropertyAnimation 之后，虽然会产生动画，但是就只有产生动画而已， layer 属性原本的值并不会因此改变，用苹果的术语，这种动画叫做 Explicit Animations。</p>
<p>CAPropertyAnimation 是一层 layer，我们通常使用的是 CAPropertyAnimation 的 subclass CABasicAnimation。设定 CABasicAnimation 的时候，主要会设定以下属性：</p>
<ul>
<li>fromValue: 要让某个属性产生变化的动画时的初始值</li>
<li>toValue: 要让某个属性产生变化的动画时结束的数值</li>
<li>byValue: 要让某个属性产生变化的动画时，介于开始与结束的中间值，但是很多时候可以不用特別设定，设成 nil 即可</li>
</ul>
<p>然后有一些设定是定义在 CAMediaTiming protocol 中，像是：</p>
<ul>
<li>duration: 这个动画要花上多少时间</li>
<li>repeatCount: 我们要执行这个动画几次，如果只要跑一次这个动画，设定成 1 即可；如果我们想要这个动画一直跑的话，不妨就把这个动画设成 NSNotFound，NSNotFound 就是整数的最大值。</li>
</ul>
<p>比方说，当我们想要让某个 layer 一直不停的旋转，我们可以修改 transform.rotation.x、transform.rotation.y、transform.rotation.z 等，要求这个 layer 是按照 x、y 还是 z 轴旋转，我们可以让 fromValue 设成 0，代表是初始还没旋转的状态，至于 toValue 设成 M_PI * 2，代表要旋转 360 度。像以下这段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[super viewDidLoad];</span><br><span class="line">self.aLayer = [[CALayer alloc] init];</span><br><span class="line">self.aLayer.frame = CGRectMake(50, 50, 100, 100);</span><br><span class="line">self.aLayer.backgroundColor = [UIColor redColor].CGColor;</span><br><span class="line">CABasicAnimation *rotateAnimation = [CABasicAnimation animationWithKeyPath:@&quot;transform.rotation.z&quot;];</span><br><span class="line">rotateAnimation.fromValue = @0.0f;</span><br><span class="line">rotateAnimation.toValue = @(M_PI * 2);</span><br><span class="line">rotateAnimation.autoreverses = YES;</span><br><span class="line">rotateAnimation.repeatCount = NSUIntegerMax;</span><br><span class="line">rotateAnimation.duration = 2.0;</span><br><span class="line">[self.aLayer addAnimation:rotateAnimation forKey:@&quot;x&quot;];</span><br><span class="line">[self.view.layer addSublayer:self.aLayer];</span><br></pre></td></tr></table></figure>
<h1 id="CAKeyframeAnimation"><a href="#CAKeyframeAnimation" class="headerlink" title="CAKeyframeAnimation"></a>CAKeyframeAnimation</h1><p>使用 CAKeyframeAnimation 与 CABasicAnimation 的主要差別在于，我们想要通过改变某个属性产生动画时，不是设定初始值与结束值，而是使用一个贝茲曲线描述（是 CGPath）。所以，当我们希望动画不只是直线前进，而是按照某种曲线移动的时候，就可以使用 CAKeyframeAnimation。</p>
<h1 id="CAAnimationGroup"><a href="#CAAnimationGroup" class="headerlink" title="CAAnimationGroup"></a>CAAnimationGroup</h1><p>一个 CALayer 可以同时执行多个 CAAnimation，当我们加入了一个 CAAnimation 之后，就会立刻执行这个动画。而我们也可以把很多个 animation 实例包装成群组（像是 layer 一边移动位置一边翻转），方法就是创建 CAAnimationGroup 实例，然后把想要变成群组的其他动画，变成 array，设定成 CAAnimationGroup 的 animations property。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CAAnimationGroup *group = [CAAnimationGroup animation];</span><br><span class="line">group.duration = 0.5;</span><br><span class="line">group.animations = @[positionAnimation, flipAnimation];</span><br><span class="line">group.delegate = self;</span><br><span class="line"></span><br><span class="line">[aLayer addAnimation:group forKey:@&quot;group&quot;];</span><br></pre></td></tr></table></figure>
<h1 id="CABasicAnimation"><a href="#CABasicAnimation" class="headerlink" title="CABasicAnimation"></a>CABasicAnimation</h1><p>CABasicAnimation 能够设定基础动画。</p>
<h2 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h2><p>使用方法<code>animationWithKeyPath:</code>对 CABasicAnimation进行实例化，并指定Layer的属性作为关键路径进行注册。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//围绕y轴旋转</span><br><span class="line">CABasicAnimation *transformAnima = [CABasicAnimation animationWithKeyPath:@&quot;transform.rotation.y&quot;];</span><br></pre></td></tr></table></figure>
<h2 id="设定动画"><a href="#设定动画" class="headerlink" title="设定动画"></a>设定动画</h2><p>设定动画的属性和说明</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>duration</td>
<td>动画的时长</td>
</tr>
<tr>
<td>repeatCount</td>
<td>重复的次数。不停重复设置为 HUGE_VALF</td>
</tr>
<tr>
<td>repeatDuration</td>
<td>设置动画的时间。在该时间内动画一直执行，不计次数。</td>
</tr>
<tr>
<td>beginTime</td>
<td>指定动画开始的时间。从开始延迟几秒的话，设置为【CACurrentMediaTime() + 秒数】 的方式</td>
</tr>
<tr>
<td>timingFunction</td>
<td>设置动画的速度变化</td>
</tr>
<tr>
<td>autoreverses</td>
<td>动画结束时是否执行逆动画</td>
</tr>
<tr>
<td>fromValue</td>
<td>所改变属性的起始值</td>
</tr>
<tr>
<td>toValue</td>
<td>所改变属性的结束时的值</td>
</tr>
<tr>
<td>byValue</td>
<td>所改变属性相同起始值的改变量</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">transformAnima.fromValue = @(M_PI_2);</span><br><span class="line">transformAnima.toValue = @(M_PI);</span><br><span class="line">transformAnima.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseInEaseOut];</span><br><span class="line">transformAnima.autoreverses = YES;</span><br><span class="line">transformAnima.repeatCount = HUGE_VALF;</span><br><span class="line">transformAnima.beginTime = CACurrentMediaTime() + 2;</span><br></pre></td></tr></table></figure>
<p>防止动画结束后回到初始状态<br>只需设置<code>removedOnCompletion</code>、<code>fillMode</code>两个属性就可以了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">transformAnima.removedOnCompletion = NO;</span><br><span class="line">transformAnima.fillMode = kCAFillModeForwards;</span><br></pre></td></tr></table></figure>
<p><strong>解释：</strong>为什么动画结束后返回原状态？</p>
<p>首先我们需要搞明白一点的是，layer动画运行的过程是怎样的？其实在我们给一个视图添加layer动画时，真正移动并不是我们的视图本身，而是 presentation layer 的一个缓存。动画开始时 presentation layer开始移动，原始layer隐藏，动画结束时，presentation layer从屏幕上移除，原始layer显示。这就解释了为什么我们的视图在动画结束后又回到了原来的状态，因为它根本就没动过。</p>
<p>这个同样也可以解释为什么在动画移动过程中，我们为何不能对其进行任何操作。</p>
<p>所以在我们完成layer动画之后，最好将我们的layer属性设置为我们最终状态的属性，然后将presentation layer 移除掉。</p>
<h2 id="添加动画"><a href="#添加动画" class="headerlink" title="添加动画"></a>添加动画</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[self.imageView.layer addAnimation:transformAnima forKey:@&quot;A&quot;];</span><br></pre></td></tr></table></figure>
<p>需要注意:</p>
<p>1)一个 CABasicAniamtion 的实例对象只是一个数据模型，和它绑定到哪一个layer上是没有关系的。</p>
<p>2)方法<code>addAnimation:forKey:</code>是将 CABasicAniamtion 对象进行了 copy 操作的。所以在将其添加到一个layer上之后，我们还可以将其再次添加到另一个layer上的。</p>
<h2 id="fillMode属性的理解"><a href="#fillMode属性的理解" class="headerlink" title="fillMode属性的理解"></a>fillMode属性的理解</h2><p>该属性定义了你的动画在开始和结束时的动作。默认值是 kCAFillModeRemoved。</p>
<ul>
<li>kCAFillModeRemoved 设置为该值，动画将在设置的 beginTime 开始执行（如没有设置beginTime属性，则动画立即执行），动画执行完成后将会layer的改变恢复原状。</li>
</ul>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-1.png?imageView/2/w/500" alt="tu"></p>
<ul>
<li>kCAFillModeForwards 设置为该值，动画即使之后layer的状态将保持在动画的最后一帧，而removedOnCompletion的默认属性值是 YES，所以为了使动画结束之后layer保持结束状态，应将removedOnCompletion设置为NO。</li>
</ul>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-2.png?imageView/2/w/500" alt="tu"></p>
<ul>
<li>kCAFillModeBackwards 设置为该值，将会立即执行动画的第一帧，不论是否设置了 beginTime属性。观察发现，设置该值，刚开始视图不见，还不知道应用在哪里。</li>
</ul>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-3.png?imageView/2/w/500" alt="tu"></p>
<ul>
<li>kCAFillModeBoth 该值是 kCAFillModeForwards 和 kCAFillModeBackwards的组合状态</li>
</ul>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-4.png?imageView/2/w/500" alt="tu"></p>
<h2 id="Animation-Easing的使用"><a href="#Animation-Easing的使用" class="headerlink" title="Animation Easing的使用"></a>Animation Easing的使用</h2><p>即属性timingFunction值的设定，有种方式来获取属性值</p>
<p>（1）使用方法<code>functionWithName:</code><br>这种方式很简单，这里只是简单说明一下取值的含义：</p>
<ul>
<li>kCAMediaTimingFunctionLinear 传这个值，在整个动画时间内动画都是以一个相同的速度来改变。也就是匀速运动。</li>
<li>kCAMediaTimingFunctionEaseIn 使用该值，动画开始时会较慢，之后动画会加速。</li>
</ul>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-5.png?imageView/2/w/500" alt="tu"></p>
<ul>
<li>kCAMediaTimingFunctionEaseOut 使用该值，动画在开始时会较快，之后动画速度减慢。</li>
</ul>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-6.png?imageView/2/w/500" alt="tu"></p>
<ul>
<li>kCAMediaTimingFunctionEaseInEaseOut 使用该值，动画在开始和结束时速度较慢，中间时间段内速度较快。</li>
</ul>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-7.png?imageView/2/w/500" alt="tu"></p>
<p>(2)使用方法<code>functionWithControlPoints: : : :</code> 实现。</p>
<h2 id="其他的一些设置属性"><a href="#其他的一些设置属性" class="headerlink" title="其他的一些设置属性"></a>其他的一些设置属性</h2><ul>
<li>repeatCount 设置动画的执行次数</li>
<li>autoreverses 默认值为 NO，将其设置为 YES</li>
<li>speed 改变动画的速度 可以直接设置动画上的speed属性，这样只有这个动画速度。</li>
</ul>
<p><code>animation.speed = 2;</code>或者在layer上设置speed属性，这样在该视图上的所有动画都提速，该视图上的所有子视图上的动画也会提速。</p>
<p>speed需注意：</p>
<ol>
<li>如果设置动画时间为4s，speed设置为2，则动画只需2s即可执行完。</li>
<li>如果同时设置了动画的speed和layer 的speed，则实际的speed为两者相乘。</li>
</ol>
<h2 id="使用总结"><a href="#使用总结" class="headerlink" title="使用总结"></a>使用总结</h2><ul>
<li>在动画执行完成之后，最好还是将动画移除掉。也就是尽量不要设置removedOnCompletion属性为NO</li>
<li>fillMode尽量取默认值就好了，不要去设置它的值。只有在极个别的情况下我们会修改它的值。</li>
<li>解决有时视图会闪动一下的问题，我们可以将layer的属性值设置为我们的动画最后要达到的值，然后再给我们的视图添加layer动画。</li>
</ul>
<h2 id="移动动画实现示例"><a href="#移动动画实现示例" class="headerlink" title="移动动画实现示例"></a>移动动画实现示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CABasicAnimation *positionAnima = [CABasicAnimation animationWithKeyPath:@&quot;position.y&quot;];</span><br><span class="line">positionAnima.duration = 0.8;</span><br><span class="line">positionAnima.fromValue = @(self.imageView.center.y);</span><br><span class="line">positionAnima.toValue = @(self.imageView.center.y-30);</span><br><span class="line">positionAnima.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseIn];</span><br><span class="line">positionAnima.repeatCount = HUGE_VALF;</span><br><span class="line">positionAnima.repeatDuration = 2;</span><br><span class="line">positionAnima.removedOnCompletion = NO;</span><br><span class="line">positionAnima.fillMode = kCAFillModeForwards;</span><br><span class="line"></span><br><span class="line">[self.imageView.layer addAnimation:positionAnima forKey:@&quot;AnimationMoveY&quot;];</span><br></pre></td></tr></table></figure>
<h3 id="组合动画的实现"><a href="#组合动画的实现" class="headerlink" title="组合动画的实现"></a>组合动画的实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CABasicAnimation *positionAnima = [CABasicAnimation animationWithKeyPath:@&quot;position.y&quot;];</span><br><span class="line">positionAnima.fromValue = @(self.imageView.center.y);</span><br><span class="line">positionAnima.toValue = @(self.imageView.center.y-30);</span><br><span class="line">positionAnima.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseIn];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CABasicAnimation *transformAnima = [CABasicAnimation animationWithKeyPath:@&quot;transform.rotation.y&quot;];</span><br><span class="line">transformAnima.fromValue = @(0);</span><br><span class="line">transformAnima.toValue = @(M_PI);</span><br><span class="line">transformAnima.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseInEaseOut];</span><br><span class="line"></span><br><span class="line">CAAnimationGroup *animaGroup = [CAAnimationGroup animation];</span><br><span class="line">animaGroup.duration = 2.0f;</span><br><span class="line">animaGroup.fillMode = kCAFillModeForwards;</span><br><span class="line">animaGroup.removedOnCompletion = NO;</span><br><span class="line">animaGroup.animations = @[positionAnima,transformAnima];</span><br><span class="line"></span><br><span class="line">[self.imageView.layer addAnimation:animaGroup forKey:@&quot;Animation&quot;];</span><br></pre></td></tr></table></figure>
<h3 id="动画开始和结束时的事件"><a href="#动画开始和结束时的事件" class="headerlink" title="动画开始和结束时的事件"></a>动画开始和结束时的事件</h3><p>为了获取动画的开始和结束事件，需要实现协议</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">positionAnima.delegate = self;</span><br></pre></td></tr></table></figure>
<h4 id="代理方法实现"><a href="#代理方法实现" class="headerlink" title="代理方法实现"></a>代理方法实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//动画开始时</span><br><span class="line">- (void)animationDidStart:(CAAnimation *)anim</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;开始了&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//动画结束时</span><br><span class="line">- (void)animationDidStop:(CAAnimation *)anim finished:(BOOL)flag</span><br><span class="line">&#123;</span><br><span class="line">    //方法中的flag参数表明了动画是自然结束还是被打断,比如调用了removeAnimationForKey:方法或removeAnimationForKey方法，flag为NO，如果是正常结束，flag为YES。</span><br><span class="line">    NSLog(@&quot;结束了&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实比较重要的是有多个动画的时候如何在代理方法中区分不同的动画<br>两种方式</p>
<p><strong>方式一：</strong><br>如果我们添加动画的视图是全局变量，可使用该方法。</p>
<p>添加动画时，我们使用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[self.imageView.layer addAnimation:animaGroup forKey:@&quot;Animation&quot;];</span><br></pre></td></tr></table></figure>
<p>所以，可根据key来区分不同的动画</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//动画开始时</span><br><span class="line">- (void)animationDidStart:(CAAnimation *)anim</span><br><span class="line">&#123;</span><br><span class="line">    if ([anim isEqual:[self.imageView.layer animationForKey:@&quot;Animation&quot;]]) &#123;</span><br><span class="line">        NSLog(@&quot;动画组执行了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意:</strong>把动画存储为一个属性然后再回调中比较，用来判定是哪个动画是不可行的。应为委托传入的动画参数是原始值的一个深拷贝，不是同一个值</p>
<p><strong>方式二：</strong><br>添加动画的视图是局部变量时，可使用该方法</p>
<p>添加动画给动画设置key-value对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[positionAnima setValue:@&quot;PositionAnima&quot; forKey:@&quot;AnimationKey&quot;];</span><br><span class="line">[transformAnima setValue:@&quot;TransformAnima&quot; forKey:@&quot;AnimationKey&quot;];</span><br></pre></td></tr></table></figure>
<p>所以，可以根据key中不同的值来进行区分不同的动画</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//动画结束时</span><br><span class="line">- (void)animationDidStop:(CAAnimation *)anim finished:(BOOL)flag</span><br><span class="line">&#123;</span><br><span class="line">    if ([[anim valueForKey:@&quot;AnimationKey&quot;]isEqualToString:@&quot;PositionAnima&quot;]) &#123;</span><br><span class="line">        NSLog(@&quot;位置移动动画执行结束&quot;);</span><br><span class="line">    &#125; else if ([[anim valueForKey:@&quot;AnimationKey&quot;]isEqualToString:@&quot;TransformAnima&quot;])&#123;</span><br><span class="line">        NSLog(@&quot;旋转动画执行结束&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/charsdavy/CAAnimationDemo.git">Demo on Github</a></p>
<h1 id="常用的animationWithKeyPath值"><a href="#常用的animationWithKeyPath值" class="headerlink" title="常用的animationWithKeyPath值"></a>常用的animationWithKeyPath值</h1><table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
<th>使用形式</th>
</tr>
</thead>
<tbody>
<tr>
<td>transform.scale</td>
<td>比例转化</td>
<td>@(0.8)</td>
</tr>
<tr>
<td>transform.scale.x</td>
<td>宽的比例</td>
<td>@(0.8)</td>
</tr>
<tr>
<td>transform.scale.y</td>
<td>高的比例</td>
<td>@(0.8)</td>
</tr>
<tr>
<td>transform.rotation.x</td>
<td>围绕x轴旋转</td>
<td>@(M_PI)</td>
</tr>
<tr>
<td>transform.rotation.y</td>
<td>围绕y轴旋转</td>
<td>@(M_PI)</td>
</tr>
<tr>
<td>transform.rotation.z</td>
<td>围绕z轴旋转</td>
<td>@(M_PI)</td>
</tr>
<tr>
<td>cornerRadius</td>
<td>圆角的设置</td>
<td>@(50)</td>
</tr>
<tr>
<td>backgroundColor</td>
<td>背景颜色的变化</td>
<td>(id)[UIColor purpleColor].CGColor</td>
</tr>
<tr>
<td>bounds</td>
<td>大小，中心不变</td>
<td>[NSValue valueWithCGRect:CGRectMake(0, 0, 200, 200)];</td>
</tr>
<tr>
<td>position</td>
<td>位置(中心点的改变)</td>
<td>[NSValue valueWithCGPoint:CGPointMake(300, 300)];</td>
</tr>
<tr>
<td>contents</td>
<td>内容，比如UIImageView的图片</td>
<td>imageAnima.toValue = (id)[UIImage imageNamed:@”to”].CGImage;</td>
</tr>
<tr>
<td>opacity</td>
<td>透明度</td>
<td>@(0.7)</td>
</tr>
<tr>
<td>contentsRect.size.width</td>
<td>横向拉伸缩放</td>
<td>@(0.4)最好是0~1之间的</td>
</tr>
</tbody>
</table>
<h1 id="附图"><a href="#附图" class="headerlink" title="附图"></a>附图</h1><p>CALayer Animatable Properties</p>
<p><img src="http://o88e8any8.bkt.clouddn.com/CAAnimation-CABasicAnimation-8.png?imageView/2/w/800" alt="tu"></p>
<h1 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h1><p><a href="https://objccn.io/issue-12-2/">Layer 中自定义属性的动画</a></p>
<p><a href="http://www.cnblogs.com/mjios/archive/2013/04/15/3021343.html">Core Animation2-CABasicAnimation</a></p>
<p><a href="http://blog.csdn.net/cocoarannie/article/details/10413301">CAAnimation——基本动画，关键帧动画和贝塞尔路径</a></p>
<p><a href="http://blog.csdn.net/iosevanhuang/article/details/14488239">CABasicAnimation的基本使用方法（移动·旋转·放大·缩小）</a></p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Animation/">Animation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UI/">UI</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/07/28/animation-layer-tree/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">图层的树状结构&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Chars Davy&nbsp;
     </div>
  </div>
</footer>

    
<script>
  var disqus_shortname = 'charstechblog';
  
  var disqus_url = 'http://charsdavy.github.io/2016/07/29/animation-caanimation/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>