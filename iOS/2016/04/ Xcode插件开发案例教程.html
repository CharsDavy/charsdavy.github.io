<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Xcode插件开发案例教程 - Chars</title>
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=8F6jO9aWZhOryqKsIFGUkSbXpyPVKDwgWwvpie3eJis1"/>
<link id="MainCss" type="text/css" rel="stylesheet" href="/skins/coffee/bundle-coffee.css?v=H7P3zU3_M529NtLVh9kKULJaZLDGv9Qz_L_VdgyN1P41"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/chars/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/chars/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/chars/wlwmanifest.xml"/>
<script src="http://common.cnblogs.com/script/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'chars', cb_enable_mathjax=false;</script>
<script src="/bundles/blog-common.js?v=ceHMEpeJXcR_f7TCJnXeZQRG1UsC0_cpwDJRs_oVInY1" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class = "post">
		<h1 class = "postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/chars/p/5336263.html">Xcode插件开发案例教程</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><h1>引言</h1>
<p>在平时开发过程中我们使用了很多的Xcode插件，虽然官方对于插件制作没有提供任何支持，但是加载三方的插件，默认还是被允许的。第三方的插件，存放在 ~/Library/Application Support/Developer/Shared/Xcode/Plug-ins文件夹中，后缀名必须是.xcplugin ，其实际上是一种bundle。所以我们创建一个插件工程，直接创建bundle工程即可。然后通过修改后缀名为.xcplugin，将其放到~/Library/Application Support/Developer/Shared/Xcode/Plug-ins目录中即可。</p>
<p>Xcode插件开发现在主要通过两种方式实现，其实也就是一种，只不过其中一种是使用别人提供的开发模板来省去很多中间步骤而已。文章会依次详细介绍两种的实现方法。</p>
<h1>准备工作</h1>
<h2>方式一：通过Bundle实现</h2>
<p>&nbsp;1.创建Bundle工程</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201603/490781-20160330144728207-192574452.png" alt="" /></p>
<p>2.工程设置</p>
<p id="首先是工程的plist文件">插件工程和普通的bundle工程还是有区别的,所以需要进行特殊的设置。</p>
<p>1）工程的plist文件</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201603/490781-20160330144905629-871612988.png" alt="" /></p>
<p>添加三项： <br />
XCPluginHasUI = NO <br />
XC4Compatible = YES <br />
DVTPlugInCompatibilityUUIDs    
这是一个数组。数组内容字符串，指示了该插件兼容的Xcode版本，只有对应版本的Xcode的UIID加入这个数组，插件才能被加载。否则，即使将插件放入Xcode的插件文件夹，插件也不会被加载。<br />
获取当前版本的Xcode的UUID方式：</p>
<p>在terminal中输入命令：</p>
<p> defaults read 
/Applications/Xcode.app/Contents/Info DVTPlugInCompatibilityUUID </p>
<p>terminal会返回一串字符串，这就是Xcode的DVTPlugInCompatibilityUUID。</p>
<p id="接下来是-build-setting了">2）Build Setting</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201603/490781-20160330145158129-342161810.png" alt="" /></p>
<p>&nbsp;</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201603/490781-20160330145210144-303815379.png" alt="" /></p>
<p>Installation Build Products Location 设置为 ${HOME} [显示的时候,显示的是你的用户目录]，这个是products的根目录。</p>
<p>Installation Directory 设置为 /Library/Application Support/Developer/Shared/Xcode/Plug-ins，这个是指定你的插件安装的目录。 注意，这里填入的其实是相对目录。插件的绝对目录是这样的，例如 /Users/yohunl/Library/Application\ Support/Developer/Shared/Xcode/Plug-ins/Alcatraz.xcplugin ，最后的绝对目录是 Installation Build Products Location和Installation Directory的结合，这也是为什么两者都要设置的原因。</p>
<p>Deployment Location 设置为 YES，这个是指示该工程不使用设置里的build location，而是用Installation Directory来确定build后放置的位置。</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201603/490781-20160330145434019-1733725866.png" alt="" /></p>
<p>默认工程生成的相关文件位置都是 Build Locations指定的，通过Deployment Location 设置为 YES告诉工程，我们不使用这个默认的设置，而是我们自定义的。</p>
<p>Wrapper extension 设置为 xcplugin，后缀名必须为xcplugin，否则不会被加载。</p>
<h2>方式二：通过模板实现</h2>
<p>&nbsp;1）下载Xcode插件开发模板</p>
<p>地址：<a href="https://github.com/kattrali/Xcode-Plugin-Template" target="_blank">https://github.com/kattrali/Xcode-Plugin-Template</a><br /><br />2）将下载下来的template复制到 ~/Library/Developer/Xcode/Templates/Project Templates/Application Plug-in/Xcode Plugin.xctemplate文件夹中，如果没有对应的文件夹就自己手动创建一个。<br /><br />3）重启Xcode，当你新建一个工程的时候就可以在OS X中看到一个Application Plug-in的选项，里面有一个Xcode Plug-in模板。</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201603/490781-20160330150045894-1159966575.png" alt="" /></p>
<h1>实现</h1>
<p>通过以上的两种准备方式，我们已可以创建Xcode插件工程，接下来就是如何实现插件功能。</p>
<p>&nbsp;1.功能需求</p>
<p>在当前选中文件中实现代码风格重构，目前主要实现setter方法这一风格重构。例如，</p>
<p>[self setName:@"Davy"]; ==&gt; self.name = @"Davy";</p>
<p>2.思路分析</p>
<p>1）找到当前文件中符合setter方法命名风格的方法调用。</p>
<p>2）替换找到的符合重构风格的代码，提醒用户保存。</p>
<p>3.技术难点</p>
<p>1）Xcode代码编辑框文件内容操作。</p>
<p>2）正则表达式书写。</p>
<p>3）Xcode代码编辑框提醒用户保存文件。</p>
<p>关于最后一点，因为Xcode对于没有保存的已修改过的文件会显灰以提示用户该文件需要保存，我们可以借鉴这种方式。另外，在查找时，如果能够实现高亮并且跟随滚动，效果会更佳。</p>
<p>4.关键代码</p>
<p>&nbsp;以上这些问题，本人在&ldquo;Refactor Code&rdquo;插件中全部实现，现在放上关键方法。</p>
<p>1）添加菜单</p>
<div class="cnblogs_code">
<pre>-(<span style="color: #0000ff;">void</span><span style="color: #000000;">) setupMenuItem
{
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Menu Item:</span>
<span style="color: #000000;">    
    NSMenuItem </span>*editMenuItem = [[NSApp mainMenu] itemWithTitle:<span style="color: #800000;">@"</span><span style="color: #800000;">Edit</span><span style="color: #800000;">"</span><span style="color: #000000;">];
    
    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (editMenuItem) {
        [[editMenuItem submenu] addItem:[NSMenuItem separatorItem]];
        
        NSMenu </span>*refactorCodeMenu = [[NSMenu alloc] initWithTitle:<span style="color: #800000;">@"</span><span style="color: #800000;">Refactor Code</span><span style="color: #800000;">"</span><span style="color: #000000;">];
        
        NSMenuItem </span>*<span style="color: #000000;">menuItem;
        menuItem </span>= [[NSMenuItem alloc] initWithTitle:<span style="color: #800000;">@"</span><span style="color: #800000;">Refactor Method Style</span><span style="color: #800000;">"</span> action:@selector(refactorMethodStyleMenuAction) keyEquivalent:<span style="color: #800000;">@""</span><span style="color: #000000;">];
        [menuItem setTarget:self];
        [refactorCodeMenu addItem:menuItem];
        
        NSMenuItem </span>*refactorCodeMenuItem = [[NSMenuItem alloc] initWithTitle:<span style="color: #800000;">@"</span><span style="color: #800000;">Refactor Code</span><span style="color: #800000;">"</span> action:nil keyEquivalent:<span style="color: #800000;">@""</span><span style="color: #000000;">];
        [refactorCodeMenuItem setSubmenu:refactorCodeMenu];
        [[editMenuItem submenu] addItem:refactorCodeMenuItem];
    }
}</span></pre>
</div>
<p>效果图如下：</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201604/490781-20160401135707035-2105407027.png" alt="" width="390" height="417" /></p>
<p>2）显示操作面板</p>
<div class="cnblogs_code">
<pre>- (<span style="color: #0000ff;">void</span><span style="color: #000000;">)refactorMethodStyleMenuAction
{
    [self.operateController showWindow:nil];
    
    NSURL </span>*url = [[NSBundle bundleForClass:[self <span style="color: #0000ff;">class</span>]] URLForResource:<span style="color: #800000;">@"</span><span style="color: #800000;">DZOperateController</span><span style="color: #800000;">"</span> withExtension:<span style="color: #800000;">@"</span><span style="color: #800000;">nib</span><span style="color: #800000;">"</span><span style="color: #000000;">];
    
    </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">url) {
        NSAlert </span>*alert =<span style="color: #000000;"> [[NSAlert alloc] init];
        alert.messageText </span>= <span style="color: #800000;">@"</span><span style="color: #800000;">Refactor Method Style could not be shown because the plugin is corrupted.</span><span style="color: #800000;">"</span><span style="color: #000000;">;
        alert.informativeText </span>= <span style="color: #800000;">@"</span><span style="color: #800000;">If you build the plugin from sources using Xcode, make sure to perform &ldquo;Clean Build Folder&ldquo; in <br />　　　　　　　　Xcode and then build the plugin again.\n\nIf you installed the plugin via Alctraz, there is a pending issue causing <br />　　　　　　　　some files to be missing in the plugin. Prefer to install it via the plugin webpage.</span><span style="color: #800000;">"</span><span style="color: #000000;">;
        [alert addButtonWithTitle:</span><span style="color: #800000;">@"</span><span style="color: #800000;">Download Latest</span><span style="color: #800000;">"</span><span style="color: #000000;">];
        [alert addButtonWithTitle:</span><span style="color: #800000;">@"</span><span style="color: #800000;">Cancel</span><span style="color: #800000;">"</span><span style="color: #000000;">];
        NSModalResponse result </span>=<span style="color: #000000;"> [alert runModal];
        
        </span><span style="color: #0000ff;">if</span> (result ==<span style="color: #000000;"> NSAlertFirstButtonReturn) {
            [[NSWorkspace sharedWorkspace] openURL:[NSURL URLWithString:</span><span style="color: #800000;">@"</span><span style="color: #800000;">https://github.com/CharsDavy/RefactorCodePlugin-Xcode</span><span style="color: #800000;">"</span><span style="color: #000000;">]];
        }
    }
}</span></pre>
</div>
<p>效果图如下：</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201604/490781-20160401135950379-1172628646.png" alt="" /></p>
<p>3）查找替换代码风格</p>
<p>这一部分是重点部分，包括如何书写正则表达式，并且利用正则表达式生成替换字符。还包括高亮代码，具体可以参见本人源码：<a href="https://github.com/CharsDavy/RefactorCodePlugin-Xcode" target="_blank">https://github.com/CharsDavy/RefactorCodePlugin-Xcode</a></p>
<p>4）最终效果图</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201604/490781-20160401140322598-323202767.png" alt="" /></p>
<h1>提交插件至Alcatraz</h1>
<p>1.打开Alcatraz的插件包仓库，地址：<a href="https://github.com/supermarin/alcatraz-packages" target="_blank">https://github.com/supermarin/alcatraz-packages</a></p>
<p>2.在简介里可以看到Alcatraz的包分为三类，分别为：插件(plugins)，配色方案(color schemes)和模板(templates)。<br /> 每个包都必须包含&rdquo;name&rdquo;、&rdquo;url&rdquo;和&rdquo;description&rdquo;字段，还有一个可选的&rdquo;screenshot&rdquo;字段。</p>
<p>3.Fork这个仓库，再克隆到本地。</p>
<p>4.以添加&rdquo;Refactor Code&rdquo;插件为例，打开packages.json文件，在&rdquo;plugins&rdquo;数组里加入：</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">    {
        </span><span style="color: #800000;">"</span><span style="color: #800000;">name</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">Refactor Code</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">url</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">https://github.com/CharsDavy/RefactorCodePlugin-Xcode.git</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">description</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">Refactor code style,such as setter method.</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        </span><span style="color: #800000;">"</span><span style="color: #800000;">screenshot</span><span style="color: #800000;">"</span>: <span style="color: #800000;">"</span><span style="color: #800000;">https://github.com/CharsDavy/RefactorCodePlugin-Xcode/raw/master/Screenshots/window.png</span><span style="color: #800000;">"</span><span style="color: #000000;">
    }</span></pre>
</div>
<p>5.提交代码到Fork的地址，再提交一个pull request到Master即可。</p>
<p>6.merged成功之后，即可看见以下效果图</p>
<p><img src="http://images2015.cnblogs.com/blog/490781/201604/490781-20160401092906176-1572332699.png" alt="" /></p>
<p>&nbsp;希望对大家有所帮助~</p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>

<script type='text/javascript'>
$(function () {
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);    
});
</script>
			

</body>
</html>
