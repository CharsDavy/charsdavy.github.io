<!DOCTYPE HTML>
<!--
	Massively by HTML5 UP
	html5up.net | @ajlkn
  Jekyll integration by somiibo.com
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--><html>
	<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<title>iOS App 启动性能优化</title>
<meta name="description" content="">

<link rel="apple-touch-icon" sizes="180x180" href="/assets/icon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/icon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/icon/favicon-16x16.png">
<link rel="manifest" href="/assets/icon/manifest.json">
<link rel="mask-icon" href="/assets/icon/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/icon/favicon.ico">
<meta name="msapplication-config" content="/assets/icon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- CSS -->
<link rel="stylesheet" href="/assets/css/main.css">
<noscript><link rel="stylesheet" href="/assets/css/noscript.css"></noscript>

	</head>
	<body class="is-loading">

		<!-- Wrapper -->
			<div id="wrapper" class="fade-in">

				<!-- Header -->
        <header id="header">
          <a href="/" class="logo">Chars's Tech Blog</a>
        </header>

				<!-- Nav -->
					<nav id="nav">

            <ul class="links">
  <li class=""><a href="/">Home</a></li>
  <li class=" active "><a href="/blog/">Blog</a></li>
  <li class=""><a href="/tags/">Tags</a></li>
  <li class=""><a href="/categories/">Categories</a></li>
  <li class=""><a href="/about/">About</a></li>
<!--   <li class=""><a href="/elements/">Elements Reference</a></li> -->
</ul>


						<ul class="icons">
              <li><a href="https://twitter.com/charsdavy" class="icon fa-twitter" rel="nofollow"><span class="label">Twitter</span></a></li>
              <li><a href="https://facebook.com/wei.deng.1460" class="icon fa-facebook" rel="nofollow"><span class="label">Facebook</span></a></li>
              <li><a href="https://instagram.com/chars.davy" class="icon fa-instagram" rel="nofollow"><span class="label">Instagram</span></a></li>
              <li><a href="https://github.com/charsdavy" class="icon fa-github" rel="nofollow"><span class="label">GitHub</span></a></li>
						</ul>
					</nav>

				<!-- Main -->
				<div id="main">
          <section class="post">
    				<header class="major">
      				<span class="date">22 Sep 2017</span>
      				<h1>iOS App 启动性能优化</h1>
      				<p></p>
<p>应用启动时间，直接影响用户对一款应用的判断和使用体验。<code class="highlighter-rouge">ZAKER新闻</code>本身就包含非常多并且复杂度高的业务模块（如新闻、视频等），也接入了很多第三方的插件，这势必会拖慢应用的启动时间，本着精益求精的态度和对用户体验的追求，我们希望在业务扩张的同时最大程度的优化启动时间。</p>


      			</header>
      			<div class="image main"><img src="" alt=""></div>
      			<p></p>
<p>应用启动时间，直接影响用户对一款应用的判断和使用体验。<code class="highlighter-rouge">ZAKER新闻</code>本身就包含非常多并且复杂度高的业务模块（如新闻、视频等），也接入了很多第三方的插件，这势必会拖慢应用的启动时间，本着精益求精的态度和对用户体验的追求，我们希望在业务扩张的同时最大程度的优化启动时间。</p>

<h2 id="启动时间">启动时间</h2>

<p>总时间 = T1 + T2</p>

<h3 id="t1">T1</h3>

<p>加载<code class="highlighter-rouge">系统dylib</code>和<code class="highlighter-rouge">可执行文件</code>的时间。</p>

<h3 id="t2">T2</h3>

<p>从<code class="highlighter-rouge">main</code>到<code class="highlighter-rouge">applicationWillFinishLaunching</code>结束的时间。</p>

<h2 id="app启动过程">App启动过程</h2>

<p><img src="http://o88e8any8.bkt.clouddn.com/ios-app-launch-time-optimize-1.png" alt="App启动过程"></p>

<p>1）解析<code class="highlighter-rouge">Info.plist</code></p>

<ul>
  <li>加载相关信息，例如如闪屏</li>
  <li>沙箱建立、权限检查</li>
</ul>

<p>2）<code class="highlighter-rouge">Mach-O</code>加载</p>

<ul>
  <li>如果是胖二进制文件，寻找合适当前CPU类别的部分</li>
  <li>加载所有依赖的<code class="highlighter-rouge">Mach-O</code>文件（递归调用<code class="highlighter-rouge">Mach-O</code>加载的方法）</li>
  <li>定位内部、外部指针引用，例如字符串、函数等</li>
  <li>执行声明为<code class="highlighter-rouge">__attribute__((constructor))</code>的C函数</li>
  <li>加载类扩展（Category）中的方法</li>
  <li>C++静态对象加载、调用ObjC的<code class="highlighter-rouge"> +load </code>函数</li>
</ul>

<p>3）程序执行</p>

<ul>
  <li>调用<code class="highlighter-rouge">main()</code>
</li>
  <li>调用<code class="highlighter-rouge">UIApplicationMain()</code>
</li>
  <li>调用<code class="highlighter-rouge">applicationWillFinishLaunching</code>
</li>
</ul>

<h3 id="mach-o">Mach-O</h3>

<p>Mach-O 是针对不同运行时可执行文件的文件类型。</p>

<p><img src="http://o88e8any8.bkt.clouddn.com/ios-app-launch-time-optimize-4.png" alt="Mach-O"></p>

<h4 id="文件类型">文件类型：</h4>

<p>Executable： 应用的主要二进制</p>

<p>Dylib： 动态链接库（又称 DSO 或 DLL）</p>

<p>Bundle： 不能被链接的 Dylib，只能在运行时使用 dlopen() 加载，可当做 macOS 的插件。</p>

<p>Image： executable，dylib 或 bundle</p>

<p>Framework： 包含 Dylib 以及资源文件和头文件的文件夹</p>

<h3 id="mach-o-镜像文件">Mach-O 镜像文件</h3>

<p>Mach-O 被划分成一些 segement，每个 segement 又被划分成一些 section。</p>

<p>segment 的名字都是大写的，且空间大小为页的整数。页的大小跟硬件有关，在 arm64 架构一页是 16KB，其余为 4KB。</p>

<p>section 虽然没有整数倍页大小的限制，但是 section 之间不会有重叠。</p>

<p>几乎所有 Mach-O 都包含这三个段（segment）： <code class="highlighter-rouge">__TEXT</code>,<code class="highlighter-rouge">__DATA</code> 和 <code class="highlighter-rouge">__LINKEDIT</code>：</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">__TEXT</code> 包含 Mach header，被执行的代码和只读常量（如C 字符串）。只读可执行（r-x）。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">__DATA</code> 包含全局变量，静态变量等。可读写（rw-）。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">__LINKEDIT</code> 包含了加载程序的『元数据』，比如函数的名称和地址。只读（r–）。</p>
  </li>
</ul>

<h3 id="mach-o-universal-文件">Mach-O Universal 文件</h3>

<p><a href="https://en.wikipedia.org/wiki/Fat_binary">FAT 二进制</a>文件，将多种架构的 Mach-O 文件合并而成。它通过 Fat Header 来记录不同架构在文件中的偏移量，Fat Header 占一页的空间。</p>

<p>按分页来存储这些 segement 和 header 会浪费空间，但这有利于虚拟内存的实现。</p>

<h3 id="什么是image">什么是image</h3>

<p>1.executable可执行文件 比如.o文件。</p>

<p>2.dylib 动态链接库 framework就是动态链接库和相应资源包含在一起的一个文件夹结构。</p>

<p>3.bundle 资源文件 只能用dlopen加载，不推荐使用这种方式加载。</p>

<p>除了我们App本身的可行性文件，系统中所有的framework比如UIKit、Foundation等都是以动态链接库的方式集成进App中的。</p>

<h3 id="什么是imageloader">什么是ImageLoader</h3>

<p>image 表示一个二进制文件(可执行文件或 so 文件)，里面是被编译过的符号、代码等，所以 ImageLoader 作用是将这些文件加载进内存，且每一个文件对应一个ImageLoader实例来负责加载。</p>

<p>两步走：在程序运行时它先将动态链接的 image 递归加载 (也就是上面测试栈中一串的递归调用的时刻)。 再从可执行文件 image 递归加载所有符号。</p>

<h2 id="冷启动和热启动">冷启动和热启动</h2>

<h3 id="冷启动">冷启动</h3>

<p>应用首次启动。即后台线程中未有当前打开的应用，所有的资源都需要加载并初始化。</p>

<h3 id="热启动">热启动</h3>

<p>应用非首次启动。即后台线程中保留有当前应用，应用的资源在内存中有保存。</p>

<h2 id="启动时间分析">启动时间分析</h2>

<p>1）开启时间分析功能</p>

<p>在Xcode的菜单中选择<code class="highlighter-rouge">Project</code>→<code class="highlighter-rouge">Scheme</code>→<code class="highlighter-rouge">Edit Scheme...</code>，然后找到<code class="highlighter-rouge"> Run</code> → <code class="highlighter-rouge">Environment Variables</code> →<code class="highlighter-rouge">+</code>，添加<code class="highlighter-rouge">name</code>为<code class="highlighter-rouge">DYLD_PRINT_STATISTICSvalue</code>为<code class="highlighter-rouge">1</code>的环境变量。</p>

<p><img src="http://o88e8any8.bkt.clouddn.com/ios-app-launch-time-optimize-2.png" alt="开启时间分析功能"></p>

<p><img src="http://o88e8any8.bkt.clouddn.com/ios-app-launch-time-optimize-3.png" alt="启动时间"></p>

<h3 id="load-dylibs-image">load dylibs image</h3>

<p>在每个动态库的加载过程中， dyld需要：</p>

<p>1.分析所依赖的动态库</p>

<p>2.找到动态库的mach-o文件</p>

<p>3.打开文件</p>

<p>4.验证文件</p>

<p>5.在系统核心注册文件签名</p>

<p>6.对动态库的每一个segment调用mmap()</p>

<p>通常的，一个App需要加载100到400个dylibs， 但是其中的系统库被优化，可以很快的加载。 针对这一步骤的优化有：</p>

<p>1.减少非系统库的依赖</p>

<p>2.合并非系统库</p>

<p>3.使用静态资源，比如把代码加入主程序</p>

<h3 id="rebasebind">rebase/bind</h3>

<p>由于ASLR(address space layout randomization)的存在，可执行文件和动态链接库在虚拟内存中的加载地址每次启动都不固定，所以需要这2步来修复镜像中的资源指针，来指向正确的地址。 rebase修复的是指向当前镜像内部的资源指针； 而bind指向的是镜像外部的资源指针。</p>

<p>rebase步骤先进行，需要把镜像读入内存，并以page为单位进行加密验证，保证不会被篡改，所以这一步的瓶颈在IO。bind在其后进行，由于要查询符号表，来指向跨镜像的资源，加上在rebase阶段，镜像已被读入和加密验证，所以这一步的瓶颈在于CPU计算。</p>

<p>优化该阶段的关键在于减少__DATA segment中的指针数量。我们可以优化的点有：</p>

<p>1.减少Objc类数量， 减少selector数量</p>

<p>2.减少C++虚函数数量</p>

<p>3.转而使用swift stuct（其实本质上就是为了减少符号的数量）</p>

<h3 id="解读">解读</h3>

<ul>
  <li>
<code class="highlighter-rouge">main()</code>函数之前总共使用了506.48ms</li>
  <li>在506.48ms中，加载动态库用了46.35ms，指针重定位使用了137.72ms，ObjC类初始化使用了95.39ms，各种初始化使用了226.92ms。</li>
  <li>在初始化耗费的226.92ms中，用时最多的几个初始化是<code class="highlighter-rouge">libSystem.B.dylib</code>、<code class="highlighter-rouge">libBacktraceRecording.dylib</code>、<code class="highlighter-rouge">libglInterpose.dylib</code>以及<code class="highlighter-rouge">libMTLInterpose.dylib</code>。</li>
</ul>

<p>2）使用instruments工作分析具体时间消耗点</p>

<h2 id="耗时的影响因素">耗时的影响因素</h2>

<p>1） <code class="highlighter-rouge">main()</code>函数之前耗时的影响因素</p>

<ul>
  <li>动态库加载越多，启动越慢。</li>
  <li>ObjC类越多，启动越慢</li>
  <li>C的<code class="highlighter-rouge">constructor</code>函数越多，启动越慢</li>
  <li>C++静态对象越多，启动越慢</li>
  <li>ObjC的<code class="highlighter-rouge">+load</code>越多，启动越慢</li>
</ul>

<p>实验证明，在ObjC类的数目一样多的情况下，需要加载的动态库越多，App启动就越慢。同样的，在动态库一样多的情况下，ObjC的类越多，App的启动也越慢。需要加载的动态库从1个上升到10个的时候，用户几乎感知不到任何分别，但从10个上升到100个的时候就会变得十分明显。同理，100个类和1000个类，可能也很难查察觉得出，但1000个类和10000个类的分别就开始明显起来。</p>

<p>同样的，尽量不要写<code class="highlighter-rouge">__attribute__((constructor))</code>的C函数，也尽量不要用到C++的静态对象；至于ObjC的<code class="highlighter-rouge">+load</code>方法，似乎大家已经习惯不用它了。任何情况下，能用<code class="highlighter-rouge">dispatch_once()</code>来完成的，就尽量不要用到以上的方法。</p>

<p>2） <code class="highlighter-rouge">main()</code>函数之后耗时的影响因素</p>

<p>从<code class="highlighter-rouge">main()</code>函数开始至<code class="highlighter-rouge">applicationWillFinishLaunching</code>结束，我们统一称为<code class="highlighter-rouge">main()</code>函数之后的部分。</p>

<ul>
  <li>执行<code class="highlighter-rouge">main()</code>函数的耗时</li>
  <li>执行<code class="highlighter-rouge">applicationWillFinishLaunching</code>的耗时</li>
  <li>
<code class="highlighter-rouge">rootViewController</code>及其<code class="highlighter-rouge">childViewController</code>的加载、<code class="highlighter-rouge">view</code>及其<code class="highlighter-rouge">subviews</code>的加载</li>
</ul>

<h2 id="实践">实践</h2>

<h3 id="移除不需要用到的类">移除不需要用到的类</h3>

<p>为了解决这个历史问题，我使用了一个叫做<a href="https://github.com/dblock/fui">fui（Find Unused Imports）</a>的开源项目，它能很好的分析出不再使用的类，准确率非常高，唯一的问题是它处理不了动态库和静态库里提供的类，也处理不了C++的类模板。</p>

<p>使用方法是在<code class="highlighter-rouge">Terminal</code>中<code class="highlighter-rouge">cd</code>到项目所在的目录，然后执行<code class="highlighter-rouge">fui find</code>，然后等上那么几分钟（是的你没有看错，真的需要好几分钟甚至需要更长的时间），就可以得到一个列表了。由于这个工具还不是100%靠谱，可根据这个列表，在Xcode中手动检查并删除不再用到的类。</p>

<h3 id="合并功能类似的类和扩展category">合并功能类似的类和扩展（Category）</h3>

<h3 id="优化applicationdidfinishlaunchingwithoptions方法">优化<code class="highlighter-rouge">application:didFinishLaunchingWithOptions:</code>方法</h3>

<h3 id="优化rootviewcontroller加载">优化<code class="highlighter-rouge">rootViewController</code>加载</h3>

<h2 id="问题">问题</h2>

<p>1）<code class="highlighter-rouge">NSUserDefaults</code>是否是瓶颈</p>

<p>2）还有其他哪些点可以做优化</p>

<p>参考文档：<a href="http://yulingtianxia.com/blog/2016/10/30/Optimizing-App-Startup-Time/">《优化 App 的启动时间》</a></p>

      		</section>

          <div class="comments-wrapper">
          <!--
          <div id="disqus_thread"></div>
          <script>
              /**
               *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
               *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
               */

              var disqus_config = function () {
                  this.page.url = '/blog/ios-app-launch-time-optimize/';  /*Replace PAGE_URL with your page's canonical URL variable*/
                  this.page.identifier = '/blog/ios-app-launch-time-optimize/'; /*Replace PAGE_IDENTIFIER with your page's unique identifier variable*/
              };

              (function() {  /* dont endit below this line */
                  var d = document, s = d.createElement('script');

                  s.src = 'https://.disqus.com/embed.js';

                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>-->

          <!-- 来必力City版安装代码 -->
          <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzY4My8xMDIzOA==">
          <script type="text/javascript">
             (function(d, s) {
                 var j, e = d.getElementsByTagName(s)[0];

                 if (typeof LivereTower === 'function') { return; }

                 j = d.createElement(s);
                 j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                 j.async = true;

                 e.parentNode.insertBefore(j, e);
             })(document, 'script');
          </script>
          <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
          </div>
        </div>
        <!-- /.comments-wrapper -->



					<!-- Footer -->
						<footer>
              <ul class="actions">
                <li><a href="/blog/" class="button">All Blog</a></li>
              </ul>
						</footer>
					</div>

				<!-- Footer -->
        <footer id="footer">
  <section>
    <form method="POST" action="https://formspree.io/chars.davy@gmail.com">
      <div class="field">
        <label for="name">Name</label>
        <input type="text" name="name" id="name">
      </div>
      <div class="field">
        <label for="email">Email</label>
        <input type="text" name="email" id="email">
      </div>
      <div class="field">
        <label for="message">Message</label>
        <textarea name="message" id="message" rows="3"></textarea>
      </div>
      <ul class="actions">
        <li><input type="submit" value="Send Message"></li>
      </ul>
    </form>
  </section>
  <section class="split contact">
    <section class="alt">
      <h3>Location</h3>
      <p>Guangzhou, China</p>
    </section>
    <section>
      <h3>QQ</h3>
      <p><a href="qq:124808738">124808738</a></p>
    </section>
    <section>
      <h3>Email</h3>
      <p><a href="mailto:chars.davy@gmail.com">chars.davy@gmail.com</a></p>
    </section>
    <section>
      <h3>Social</h3>
      <ul class="icons alt">
        <li><a href="https://twitter.com/charsdavy" class="icon fa-twitter" rel="nofollow"><span class="label">Twitter</span></a></li>
        <li><a href="https://facebook.com/wei.deng.1460" class="icon fa-facebook" rel="nofollow"><span class="label">Facebook</span></a></li>
        <li><a href="https://instagram.com/chars.davy" class="icon fa-instagram" rel="nofollow"><span class="label">Instagram</span></a></li>
        <li><a href="https://github.com/charsdavy" class="icon fa-github" rel="nofollow"><span class="label">GitHub</span></a></li>
      </ul>
    </section>
  </section>
</footer>
<div id="back-top" style="position:fixed;bottom:40px;right:30px;cursor: pointer;">
  <a href="#top" title="返回顶部"><img src="/images/arrow-up.png"></a>
</div>
<script type="text/javascript">
  $("#back-top").hide();
  $(document).ready(function () {
    $(window).scroll(function () {
      if ($(this).scrollTop() > 800) {
        $('#back-top').fadeIn();
      } else {
        $('#back-top').fadeOut();
      }
    });
    $('#back-top a').click(function () {
      $('body,html').animate({
        scrollTop: 0
      }, 1200);
      return false;
    });
  });
</script>
<!-- Copyright -->
<div id="copyright">
  <ul>
<li>2016 - 2018 © Chars</li>
<li>Design by <a href="https://html5up.net" rel="nofollow">HTML5 UP</a>
</li>
<li>Jekyll Integration by <a href="https://soundgrail.com">SoundGrail</a>
</li>
</ul>
</div>


			</div>

      <!-- Scripts -->
  		<!-- DYN -->
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/jquery.scrollex.min.js"></script>
<script src="/assets/js/jquery.scrolly.min.js"></script>
<script src="/assets/js/skel.min.js"></script>
<script src="/assets/js/util.js"></script>
<script src="/assets/js/main.js"></script>

			<script async src="https://www.googletagmanager.com/gtag/js?id=UA-80507808-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-80507808-1');
</script>


	</body>
</html>
